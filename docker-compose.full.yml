version: '3.8'
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: paddlers
      POSTGRES_USER: paddlers
      POSTGRES_PASSWORD: paddlers
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    depends_on:
      - postgres
    environment:
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=paddlers
      - DB_USER=paddlers
      - DB_PASSWORD=paddlers
      - SERVER_PORT=8081
      - SPRING_MAIN_ALLOW_BEAN_DEFINITION_OVERRIDING=true
      # Use the 'prod' profile in docker-compose so the service uses Postgres + Flyway
      - SPRING_PROFILES_ACTIVE=prod
      # If the DB already contains tables (e.g., from previous runs), allow Flyway to
      # baseline the existing schema so migrations can be applied safely.
      - SPRING_FLYWAY_BASELINE_ON_MIGRATE=true
    ports:
      - "8081:8081"

  web-admin:
    build:
      context: ./apps/web-admin
      dockerfile: Dockerfile
    ports:
      - "5173:80"
    depends_on:
      - backend

  web-player:
    build:
      context: ./apps/web-player
      dockerfile: Dockerfile
    ports:
      - "5174:80"
    depends_on:
      - backend

  # Mobile helper services: Metro (shared bundler), Android emulator (containerized),
  # and a macOS-mounted helper for iOS simulator tasks. Note: iOS Simulator cannot run
  # inside a Linux container; the helper service provides project files and runs Metro
  # so the host macOS can build & launch the simulator.
  mobile-metro:
    image: node:18-bullseye
    container_name: thepaddlers_mobile_metro
    working_dir: /app
    volumes:
      - ./:/app:cached
    ports:
      - "19000:19000" # Expo (LAN)
      - "19001:19001" # Expo tunnel
      - "8081:8081"   # Metro
    environment:
      - NODE_ENV=development
    command: sh -c "cd apps/mobile && yarn install --frozen-lockfile || true && yarn start --host 0.0.0.0"
    networks:
      - default

  mobile-android-emulator:
    image: budtmo/docker-android-x86-11.0
    container_name: thepaddlers_android_emulator
    privileged: true
    shm_size: "2gb"
    ports:
      - "5555:5555" # adb
      - "6080:6080" # VNC / web UI
    volumes:
      - /dev/kvm:/dev/kvm
      - ./:/app:cached
    environment:
      - DEVICE=Android_SDK_built_for_x86_64
      - ADB_SERVER_PORT=5555
    networks:
      - default

  mobile-ios-sim:
    image: node:18-bullseye
    container_name: thepaddlers_ios_helper
    working_dir: /app
    volumes:
      - ./:/app:cached
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - NODE_ENV=development
    command: sh -c "cd apps/mobile && yarn install --frozen-lockfile || true && sleep infinity"
    networks:
      - default
    # Note: iOS Simulator cannot run inside a Linux container. Use this service as a Metro/helper:
    # - Start Metro via mobile-metro (or enter this container) and on your macOS host run:
    #   xcrun simctl boot <device-udid> && npx react-native run-ios --udid <device-udid>
    # The helper provides project files and scripts accessible to the host for building/launching the simulator.

volumes:
  pgdata:

networks:
  default:
    name: thepaddlers_default
